<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>MCD Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0e1420; --card:#141b2a; --muted:#8ba3c7; --text:#e6eefc; --accent:#6aa4ff;
  --ok:#19c37d; --warn:#ffb020; --bad:#ff5d5d; --chip:#1f2840; --hover:#1b2436;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:15px/1.45 'Inter', system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
.container{max-width:1220px;margin:24px auto;padding:0 16px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media (max-width:960px){.row{grid-template-columns:1fr}}
.card{background:var(--card);border-radius:16px;padding:16px;box-shadow:0 12px 30px rgba(0,0,0,.35)}
.card h2,.card h3{margin:4px 0 12px}
.input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2b3550;background:#10182a;color:var(--text)}
.btn{padding:10px 14px;border-radius:10px;border:0;background:var(--accent);color:#051024;font-weight:700;cursor:pointer}
.btn.ghost{background:#26324d;color:#c9d7ff}
.small{font-size:12px;color:var(--muted)}
.header-nums{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin:16px 0}
.headbox{background:#11182a;border:1px solid #27304a;padding:14px;border-radius:14px;text-align:center}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#1f2840;color:#9fb4de;font-size:12px}
.list{margin-top:8px;max-height:46vh;overflow:auto;border:1px solid #27304a;border-radius:10px}
.chart{height:280px}
.data-table{width:100%;border-collapse:collapse;margin-top:10px;font-size:.9rem}
.data-table th,.data-table td{border:1px solid #27304a;padding:6px 10px;text-align:center}
.data-table th{background:#10182a;position:sticky;top:0}
.hidden{display:none}
.sticky-fab{position:fixed;right:16px;bottom:16px}
.flex{display:flex;gap:8px;flex-wrap:wrap}
.table-wrap{max-height:55vh;overflow:auto;border:1px solid #27304a;border-radius:12px;margin-top:8px}
@media (max-width:640px){.kv{grid-template-columns:1fr}}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Injected by Go -->
<script>window.__EMP__={{EMP_JSON}};</script>
<script>window.__SCH__={{SCH_JSON}};</script>
<script>window.__STAFF__={{STAFF_JSON}};</script>
<script>window.__DEMO_ZONES__={{DEMO_ZONES_JSON}};</script>
<script>window.__DEMO_OVERALL__={{DEMO_OVERALL_JSON}};</script>
<!-- ‚úÖ Inject category & gender data from Go -->
<script>
try {
  window.CATEGORY_WISE_JSON = {{.CATEGORY_WISE_JSON}};
  window.GENDER_WISE_JSON   = {{.GENDER_WISE_JSON}};
  console.log("‚úÖ Injected CATEGORY_WISE_JSON:", window.CATEGORY_WISE_JSON);
  console.log("‚úÖ Injected GENDER_WISE_JSON:", window.GENDER_WISE_JSON);
} catch (err) {
  console.error("‚ö†Ô∏è JSON injection failed", err);
}
</script>

<!-- ‚úÖ New injected data for category & gender charts -->
<script>
window.CATEGORY_WISE_JSON = {{CATEGORY_WISE_JSON}};
window.GENDER_WISE_JSON = {{GENDER_WISE_JSON}};
console.log("‚úÖ Category/Gender JSON injected:", window.CATEGORY_WISE_JSON, window.GENDER_WISE_JSON);
</script>

<script>
const EMP = Array.isArray(window.__EMP__) || typeof window.__EMP__==='object' ? window.__EMP__ : {};
const SCH = Array.isArray(window.__SCH__) || typeof window.__SCH__==='object' ? window.__SCH__ : {};
const STAFF = Array.isArray(window.__STAFF__) ? window.__STAFF__ : (typeof window.__STAFF__==='string' ? JSON.parse(window.__STAFF__) : (window.__STAFF__||[]));
const DEMO_ZONES = Array.isArray(window.__DEMO_ZONES__) ? window.__DEMO_ZONES__ : (typeof window.__DEMO_ZONES__==='string'?JSON.parse(window.__DEMO_ZONES__):[]);
const DEMO_OVERALL = (typeof window.__DEMO_OVERALL__==='object') ? window.__DEMO_OVERALL__ : (typeof window.__DEMO_OVERALL__==='string'?JSON.parse(window.__DEMO_OVERALL__):{});
const ZLBL={{ZLBL}}||[];
const ZVAL={{ZVAL}}||[];
const DLBL={{DLBL}}||[];
const DVAL={{DVAL}}||[];
</script>
</head>
<body>
<div class="container">
  <h1 style="margin:0 0 8px">üß≠ MCD Dashboard</h1>

  <div class="header-nums">
    <div class="headbox"><div class="small">TOTAL EMPLOYEES</div><div style="font-size:28px" id="num-emps">{{TOTAL_EMP}}</div></div>
    <div class="headbox"><div class="small">SCHOOLS</div><div style="font-size:28px" id="num-schools">{{TOTAL_SCHOOLS}}</div></div>
    <div class="headbox"><div class="small">ZONES</div><div style="font-size:28px" id="num-zones">{{TOTAL_ZONES}}</div></div>
    <div class="headbox"><div class="small">DESIGNATIONS</div><div style="font-size:28px" id="num-desigs">{{TOTAL_DESIGS}}</div></div>
  </div>

  <div class="row">
    <div class="card">
      <h3>Zone-wise Distribution</h3>
      <canvas id="zoneChart" class="chart"></canvas>
    </div>
    <div class="card">
      <h3>Top Designations</h3>
      <canvas id="desigChart" class="chart"></canvas>
    </div>
  </div>

  <div class="row" id="demographics-section">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">üìä Zone-wise Gender Distribution</h3>
        <button class="btn ghost" onclick="toggle('demoZoneWrap', this)">Hide</button>
      </div>
      <div id="demoZoneWrap"><canvas id="demoZoneChart" class="chart"></canvas></div>
    </div>
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">üìä Category-wise (Overall)</h3>
        <button class="btn ghost" onclick="toggle('demoOverallWrap', this)">Hide</button>
      </div>
      <div id="demoOverallWrap"><canvas id="demoOverallChart" class="chart"></canvas></div>
    </div>
  </div>

  <div class="row">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">üéÇ Birthdays Today</h3>
        <button class="btn ghost" onclick="toggle('bday-body', this)">Hide</button>
      </div>
      <div id="bday-body"><ul id="bday-list" style="margin:8px 0 0 16px;padding:0"></ul></div>
      <div class="small" id="bday-summary" style="margin-top:6px"></div>
      <div style="margin-top:10px">
        <button class="btn ghost" onclick="sendBirthdays()">üìß Send Birthday Emails</button>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">üèÖ Work Anniversaries Today</h3>
        <button class="btn ghost" onclick="toggle('ann-body', this)">Hide</button>
      </div>
      <div id="ann-body"><ul id="ann-list" style="margin:8px 0 0 16px;padding:0"></ul></div>
      <div class="small" id="ann-summary" style="margin-top:6px"></div>
      <div style="margin-top:10px">
        <button class="btn ghost" onclick="sendAnniversaries()">üìß Send Work Anniversary Emails</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">üìã Zone-wise Demographic Summary</h3>
      <button class="btn ghost" onclick="exportDemoCSV()">üíæ Export CSV</button>
    </div>
    <div class="table-wrap">
      <table class="data-table" id="demoTable">
        <thead>
          <tr>
            <th>Zone</th>
            <th>Designation</th>
            <th>GEN ‚ôÇ</th><th>GEN ‚ôÄ</th>
            <th>SC ‚ôÇ</th><th>SC ‚ôÄ</th>
            <th>ST ‚ôÇ</th><th>ST ‚ôÄ</th>
            <th>OBC ‚ôÇ</th><th>OBC ‚ôÄ</th>
            <th>Total Male</th><th>Total Female</th><th>Total</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="row">
    <div class="card">
      <h3>School Search (by Name)</h3>
      <input id="schname" class="input" placeholder="e.g., rohini, jklm" oninput="searchSchoolByName()">
      <div class="list" id="schname-results"></div>
    </div>
    <div class="card">
      <h3>Employee Search (by Name)</h3>
      <input id="empname" class="input" placeholder="e.g., jyoti, amit" oninput="searchEmpByName()">
      <div class="list" id="empname-results"></div>
    </div>
  </div>

  <div class="row">
    <div class="card">
      <h3>üè´ School Lookup (by ID)</h3>
      <div style="display:flex;gap:8px">
        <input id="schid" class="input" placeholder="Enter School ID (e.g., 1354439)">
        <button class="btn" onclick="findSchool()">Search</button>
      </div>
      <div id="sch-out" style="margin-top:12px"></div>
    </div>

    <div class="card">
      <h3>üßë‚Äçüè´ Employee Lookup (by ID)</h3>
      <div style="display:flex;gap:8px">
        <input id="empid" class="input" placeholder="Enter Employee ID">
        <button class="btn" onclick="findEmp()">Search</button>
      </div>
      <div id="emp-out" style="margin-top:12px"></div>
    </div>
  </div>

  <!-- NEW: Advanced Employee Filter (bottom) -->
  <div class="card" id="advanced-filters">
    <h3>üîé Advanced Employee Filter</h3>
    <div class="flex">
      <div style="flex:1;min-width:180px">
        <label class="small">Zone</label>
        <select id="f-zone"></select>
      </div>
      <div style="flex:1;min-width:200px">
        <label class="small">Designation</label>
        <select id="f-desig"></select>
      </div>
      <div style="flex:1;min-width:140px">
        <label class="small">Gender</label>
        <select id="f-gender">
          <option value="ALL">All</option>
          <option value="MALE">Male</option>
          <option value="FEMALE">Female</option>
        </select>
      </div>
      <div style="flex:1;min-width:180px">
        <label class="small">Marital Status</label>
        <select id="f-marital"></select>
      </div>
      <div style="flex:1;min-width:160px">
        <label class="small">Age (>=)</label>
        <select id="f-age">
          <option value="0">All</option>
          <option value="20">20+</option>
          <option value="25">25+</option>
          <option value="30">30+</option>
          <option value="35">35+</option>
          <option value="40">40+</option>
          <option value="45">45+</option>
          <option value="50">50+</option>
          <option value="55">55+</option>
        </select>
      </div>
      <div style="flex:1;min-width:160px">
        <label class="small">Category</label>
        <select id="f-cat"></select>
      </div>
    </div>
    <div class="flex" style="margin-top:10px">
      <button class="btn" onclick="runEmpFilter()">Apply Filters</button>
      <button class="btn ghost" onclick="resetEmpFilter()">Reset</button>
      <button class="btn ghost" onclick="exportEmpCSV()">Export CSV</button>
    </div>
    <div class="table-wrap">
      <table class="data-table" id="empFilterTable">
        <thead><tr>
          <th>Employee</th><th>Designation</th><th>Zone</th><th>Gender</th><th>Marital</th><th>Category</th><th>Age</th><th>School</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- NEW: Staff Summary Filter (separate card) -->
  <div class="card" id="staff-filters">
    <h3>üë• Staff Summary Filter</h3>
    <div class="flex">
      <div style="flex:1;min-width:200px">
        <label class="small">Zone</label>
        <select id="sf-zone"></select>
      </div>
      <div style="flex:1;min-width:200px">
        <label class="small">Status</label>
        <select id="sf-status">
          <option value="ALL">All</option>
          <option value="SURPLUS">Surplus</option>
          <option value="VACANT">Vacant</option>
          <option value="BALANCED">Balanced</option>
        </select>
      </div>
      <div style="flex:1;min-width:200px">
        <label class="small">Principal</label>
        <select id="sf-principal">
          <option value="ALL">All</option>
          <option value="AVAILABLE">Available</option>
          <option value="VACANT">Vacant</option>
        </select>
      </div>
      <div style="flex:1;min-width:220px">
        <label class="small">Special Educator</label>
        <select id="sf-se">
          <option value="ALL">All</option>
          <option value="AVAILABLE">Available</option>
          <option value="VACANT">Vacant</option>
        </select>
      </div>
    </div>
    <div class="flex" style="margin-top:10px">
      <button class="btn" onclick="runStaffFilter()">Apply Filters</button>
      <button class="btn ghost" onclick="resetStaffFilter()">Reset</button>
      <button class="btn ghost" onclick="exportStaffCSV()">Export CSV</button>
    </div>
    <div class="table-wrap">
      <table class="data-table" id="staffTable">
        <thead><tr>
          <th>School</th><th>Zone</th><th>Needed</th><th>Actual</th><th>Surplus/Vacancy</th><th>Principal</th><th>Special Educator</th><th>Ratio</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="small" id="staffSummary" style="margin-top:6px"></div>
  </div>

  <button class="btn sticky-fab" onclick="window.print()">üñ®Ô∏è Print PDF</button>
</div>

<script>
function toggle(id, btn){
  const el=document.getElementById(id);
  if(!el) return;
  el.classList.toggle('hidden');
  if(btn){ btn.textContent = el.classList.contains('hidden') ? 'Show' : 'Hide'; }
}

// charts
(function(){
  try{
    const zctx=document.getElementById('zoneChart').getContext('2d');
    new Chart(zctx,{type:'bar',data:{labels:ZLBL,datasets:[{label:'Employees',data:ZVAL}]}});
    const dctx=document.getElementById('desigChart').getContext('2d');
    new Chart(dctx,{type:'bar',data:{labels:DLBL,datasets:[{label:'Employees',data:DVAL}]}});
  }catch(e){console.warn('chart init',e);}
})();

(function(){ // demographics preview charts
  if(!Array.isArray(DEMO_ZONES) || DEMO_ZONES.length===0) return;
  const zoneLabels=[], maleCounts=[], femaleCounts=[];
  for(const z of DEMO_ZONES){
    let m=0,f=0;
    for(const d of z.designations){ m+=d.stats.total_male; f+=d.stats.total_female; }
    zoneLabels.push(z.zone); maleCounts.push(m); femaleCounts.push(f);
  }
  const ctxZ=document.getElementById("demoZoneChart");
  if(ctxZ){
    new Chart(ctxZ,{type:'bar',data:{labels:zoneLabels,datasets:[{label:'Male',data:maleCounts},{label:'Female',data:femaleCounts}]},options:{plugins:{legend:{position:'bottom'}}}});
  }
  const ctxO=document.getElementById("demoOverallChart");
  if(ctxO && DEMO_OVERALL && Array.isArray(DEMO_OVERALL.designations)){
    let totals={GEN:0,SC:0,ST:0,OBC:0};
    for(const d of DEMO_OVERALL.designations){
      const s=d.stats;
      totals.GEN+=s.gen_male+s.gen_female;
      totals.SC+=s.sc_male+s.sc_female;
      totals.ST+=s.st_male+s.st_female;
      totals.OBC+=s.obc_male+s.obc_female;
    }
    new Chart(ctxO,{type:'pie',data:{labels:Object.keys(totals),datasets:[{data:Object.values(totals)}]}});
  }
})();

function exportDemoCSV(){
  const rows=[["Zone","Designation","GEN_M","GEN_F","SC_M","SC_F","ST_M","ST_F","OBC_M","OBC_F","Total_M","Total_F","Total"]];
  if(Array.isArray(DEMO_ZONES)){
    for(const z of DEMO_ZONES){
      for(const d of z.designations){
        const s=d.stats||{};
        rows.push([z.zone,d.designation,s.gen_male||0,s.gen_female||0,s.sc_male||0,s.sc_female||0,s.st_male||0,s.st_female||0,s.obc_male||0,s.obc_female||0,s.total_male||0,s.total_female||0,s.total||0]);
      }
    }
  }
  const csv = rows.map(r=>r.map(v=>String(v).replace(/"/g,'""')).map(v=>`"${v}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='demographics_zone_summary.csv'; document.body.appendChild(a); a.click(); a.remove();
}

// ---------- simple search by name ----------
function searchSchoolByName(){
  const q=(document.getElementById('schname')||{}).value||''; const wrap=document.getElementById('schname-results'); if(!wrap) return;
  wrap.innerHTML=''; const qq=q.trim().toLowerCase(); if(!qq) return;
  const arr=[]; for(const sid in SCH){ const s = SCH[sid]; if(!s||!s.name) continue; if(s.name.toLowerCase().includes(qq)){ arr.push(s); } }
  if(!arr.length){ wrap.innerHTML='<div class="small">No matching schools</div>'; return; }
  arr.sort((a,b)=>a.name.localeCompare(b.name));
  wrap.innerHTML = arr.slice(0,40).map(s=>`<div class="item" onclick="openSchool('${s.id}')"><div><b>${s.name}</b></div><div class="small">${s.id} ‚Ä¢ ${s.zone||''}</div></div>`).join('');
}
function searchEmpByName(){
  const q=(document.getElementById('empname')||{}).value||''; const wrap=document.getElementById('empname-results'); if(!wrap) return;
  wrap.innerHTML=''; const qq=q.trim().toLowerCase(); if(!qq) return;
  const arr=[]; for(const id in EMP){ const e = EMP[id]; if(!e||!e.name) continue; if(e.name.toLowerCase().includes(qq)){ arr.push(e); } }
  if(!arr.length){ wrap.innerHTML='<div class="small">No matching employees</div>'; return; }
  arr.sort((a,b)=>a.name.localeCompare(b.name));
  wrap.innerHTML = arr.slice(0,40).map(e=>`<div class="item" onclick="openEmployee('${e.id}')"><div><b>${e.name}</b> <span class="badge">${e.designation||''}</span></div><div class="small">${e.id} ‚Ä¢ ${e.school_name||''}</div></div>`).join('');
}
function openSchool(sid){ const inp=document.getElementById('schid'); if(inp) inp.value = sid; const w=document.getElementById('schname-results'); if(w) w.innerHTML=''; findSchool(); window.scrollTo({top:0,behavior:'smooth'}); }
function openEmployee(id){ const inp=document.getElementById('empid'); if(inp) inp.value = id; const w=document.getElementById('empname-results'); if(w) w.innerHTML=''; findEmp(); window.scrollTo({top:0,behavior:'smooth'}); }

// ---------- lookups ----------
function digitsOnlyKey(s){ const m=String(s||'').match(/(\d{5,})/); return m?m[1]:''; }
function cleanNum(s){ s=String(s||'').trim(); return s.endsWith('.0')?s.slice(0,-2):s; }

function findSchool(){
  const raw=(document.getElementById('schid')||{}).value||''; const sid=digitsOnlyKey(raw); const out=document.getElementById('sch-out');
  if(!out) return; if(!sid||!SCH[sid]){ out.innerHTML='<div class="small">No school found.</div>'; return; }
  const s = SCH[sid];
  const need = Math.ceil((s.max_present_students||0)/40.0);
  const tCount = Object.values(EMP).filter(e=>e.school_id===sid && (e.designation||'').toLowerCase().includes('teacher')).length;
  const principal = Object.values(EMP).filter(e=>e.school_id===sid && (e.designation||'').toLowerCase().includes('principal')).length>0;
  const surplus = tCount-need;
  const vacBadge = surplus>0? `<span class="badge" style="background:var(--ok);color:#031">Surplus ${surplus}</span>` :
                  surplus<0? `<span class="badge" style="background:#ffcc00;color:#001f3f;font-weight:bold;">Vacancy ${-surplus}</span>` :
                             `<span class="badge">Balanced</span>`;
  const pBadge = principal? `<span class="badge" style="background:var(--ok);color:#031">Principal: Available</span>`:
                          `<span class="badge" style="background:#ffcccc;color:#8b0000;font-weight:bold;">Principal: Vacant</span>`;
  out.innerHTML = `
  <div class="row">
    <div class="card">
      <h3>School Info</h3>
      <div><b>${s.name||''}</b></div>
      <div class="small">${s.id} ‚Ä¢ ${s.zone||''}</div>
      <div class="small">SI: ${s.si_name||''}</div>
    </div>
    <div class="card">
      <h3>Staffing & Ratio</h3>
      <div>Teachers: <span class="badge">${tCount}</span></div>
      <div>Needed @1:40: <span class="badge">${need}</span></div>
      <div>Status: ${vacBadge}</div>
      <div>Principal: ${pBadge}</div>
    </div>
  </div>`;
}

function findEmp(){
  const key=(document.getElementById('empid')||{}).value||''; const out=document.getElementById('emp-out');
  if(!out) return; const rec=EMP[key]||EMP[cleanNum(key)];
  if(!rec){ out.innerHTML='<div class="small">No employee found.</div>'; return; }
  out.innerHTML = `
  <div class="card">
    <h3>${rec.name||''} <span class="badge">${rec.designation||''}</span></h3>
    <div class="small">${rec.id} ‚Ä¢ ${rec.zone||''} ‚Ä¢ ${rec.school_name||''}</div>
    <div class="small">Gender: ${rec.gender||''} ‚Ä¢ Category: ${rec.selection_category||''} ‚Ä¢ Marital: ${rec.marital_status||''} ‚Ä¢ Age: ${rec.age||''}</div>
    <div class="small">DOJ: ${rec.doj||''} ‚Ä¢ Email: ${rec.email||''} ‚Ä¢ Mobile: ${cleanNum(rec.mobile)||''}</div>
  </div>`;
}

// ====== Advanced Employee Filter ======
function titleCase(s){ if(!s) return s; return s.toLowerCase().replace(/\b\w/g, c=>c.toUpperCase()); }
function initEmpFilterOptions(){
  const zones=new Set(["ALL"]); const desigs=new Set(["ALL"]); const cats=new Set(["ALL"]); const maritals=new Set(["ALL"]);
  for(const id in EMP){
    const e=EMP[id];
    if(e.zone) zones.add(e.zone);
    if(e.designation) desigs.add(e.designation);
    if(e.selection_category) cats.add(String(e.selection_category).toUpperCase());
    if(e.marital_status) maritals.add(titleCase(String(e.marital_status)));
  }
  const fill=(id,set)=>{ const sel=document.getElementById(id); if(!sel) return; sel.innerHTML=''; for(const v of Array.from(set)){ sel.insertAdjacentHTML('beforeend', `<option value="${v}">${v}</option>`); } };
  fill('f-zone', zones); fill('f-desig', desigs); fill('f-cat', cats); fill('f-marital', maritals);
  document.getElementById('f-zone').value='ALL';
  document.getElementById('f-desig').value='ALL';
  document.getElementById('f-cat').value='ALL';
  document.getElementById('f-marital').value='ALL';
}
function runEmpFilter(){
  const z=(document.getElementById('f-zone').value||'ALL').toUpperCase();
  const d=(document.getElementById('f-desig').value||'ALL').toUpperCase();
  const g=(document.getElementById('f-gender').value||'ALL').toUpperCase();
  const m=(document.getElementById('f-marital').value||'ALL').toUpperCase();
  const a=parseInt(document.getElementById('f-age').value||'0',10);
  const c=(document.getElementById('f-cat').value||'ALL').toUpperCase();
  const tbody=document.querySelector('#empFilterTable tbody'); if(!tbody) return;
  tbody.innerHTML='';
  let rows=0;
  for(const id in EMP){
    const e=EMP[id];
    const Z=(e.zone||'').toUpperCase();
    const D=(e.designation||'').toUpperCase();
    const G=(e.gender||'').toUpperCase();
    const M=titleCase(e.marital_status||'').toUpperCase();
    const C=(e.selection_category||'').toUpperCase();
    const AGE=parseInt(e.age||0,10);
    if((z==='ALL'||Z===z) && (d==='ALL'||D===d) && (g==='ALL'||G===g) && (m==='ALL'||M===m) && (c==='ALL'||C===c) && (AGE>=a)){
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${e.name||''}</td><td>${e.designation||''}</td><td>${e.zone||''}</td><td>${e.gender||''}</td><td>${titleCase(e.marital_status||'')}</td><td>${e.selection_category||''}</td><td>${e.age||''}</td><td>${e.school_name||''}</td>`;
      tbody.appendChild(tr); rows++;
    }
  }
  if(rows===0){ tbody.innerHTML='<tr><td colspan="8" class="small">No matching employees.</td></tr>'; }
}
function resetEmpFilter(){ initEmpFilterOptions(); document.getElementById('f-gender').value='ALL'; document.getElementById('f-age').value='0'; runEmpFilter(); }
function exportEmpCSV(){
  const rows=[["Employee","Designation","Zone","Gender","Marital","Category","Age","School"]];
  const tbody=document.querySelector('#empFilterTable tbody'); if(!tbody) return;
  for(const tr of tbody.querySelectorAll('tr')){
    const tds=[...tr.children].map(td=>td.textContent);
    if(tds.length===8){ rows.push(tds); }
  }
  const csv = rows.map(r=>r.map(v=>String(v).replace(/"/g,'""')).map(v=>`"${v}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='employee_filter_results.csv'; document.body.appendChild(a); a.click(); a.remove();
}

// ====== Staff Summary Filter ======
function initStaffFilterOptions(){
  const zones=new Set(["ALL"]);
  if(Array.isArray(STAFF)){ for(const s of STAFF){ if(s.zone) zones.add(s.zone); } }
  const sel=document.getElementById('sf-zone'); if(sel){ sel.innerHTML=''; for(const v of Array.from(zones)){ sel.insertAdjacentHTML('beforeend', `<option value="${v}">${v}</option>`); } sel.value='ALL'; }
}
function runStaffFilter(){
  const z=(document.getElementById('sf-zone').value||'ALL').toUpperCase();
  const status=(document.getElementById('sf-status').value||'ALL').toUpperCase();
  const p=(document.getElementById('sf-principal').value||'ALL').toUpperCase();
  const se=(document.getElementById('sf-se').value||'ALL').toUpperCase();
  const tbody=document.querySelector('#staffTable tbody'); if(!tbody) return; tbody.innerHTML='';
  let n=0,vac=0,sur=0,bal=0;
  if(!Array.isArray(STAFF)){ console.warn('STAFF not an array', STAFF); }
  for(const s of (Array.isArray(STAFF)?STAFF:[])){
    const Z=(s.zone||'').toUpperCase();
    const sv=parseInt(s.surplus_vacancy||0,10);
    const st = sv>0?'SURPLUS':(sv<0?'VACANT':'BALANCED');
    const P = s.has_principal ? 'AVAILABLE' : 'VACANT';
    const SE = s.has_special_educator ? 'AVAILABLE' : 'VACANT';
    if((z==='ALL'||Z===z) && (status==='ALL'||st===status) && (p==='ALL'||P===p) && (se==='ALL'||SE===se)){
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${s.name}</td><td>${s.zone}</td><td>${s.needed_teachers}</td><td>${s.actual_teachers}</td><td>${sv}</td><td>${P}</td><td>${SE}</td><td>${(s.ratio||0).toFixed(2)}</td>`;
      tbody.appendChild(tr); n++;
      if(st==='VACANT') vac++; else if(st==='SURPLUS') sur++; else bal++;
    }
  }
  if(n===0){ tbody.innerHTML='<tr><td colspan="8" class="small">No matching schools.</td></tr>'; }
  const sum=document.getElementById('staffSummary'); if(sum) sum.textContent=`Showing ${n} schools ‚Äî Vacant: ${vac}, Surplus: ${sur}, Balanced: ${bal}`;
}
function resetStaffFilter(){ initStaffFilterOptions(); document.getElementById('sf-status').value='ALL'; document.getElementById('sf-principal').value='ALL'; document.getElementById('sf-se').value='ALL'; runStaffFilter(); }

// ====== init on load ======
window.addEventListener('DOMContentLoaded', ()=>{
  // Build demographic table body (zone/designation)
  const tbody=document.querySelector("#demoTable tbody");
  if(tbody && Array.isArray(DEMO_ZONES)){
    tbody.innerHTML='';
    for(const z of DEMO_ZONES){
      for(const d of z.designations){
        const s=d.stats||{};
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${z.zone}</td><td>${d.designation}</td><td>${s.gen_male||0}</td><td>${s.gen_female||0}</td><td>${s.sc_male||0}</td><td>${s.sc_female||0}</td><td>${s.st_male||0}</td><td>${s.st_female||0}</td><td>${s.obc_male||0}</td><td>${s.obc_female||0}</td><td>${s.total_male||0}</td><td>${s.total_female||0}</td><td>${s.total||0}</td>`;
        tbody.appendChild(tr);
      }
    }
  }
  initEmpFilterOptions(); runEmpFilter();
  initStaffFilterOptions(); runStaffFilter();
});

// Email actions
async function sendBirthdays(){ try{ const r = await fetch('/send-birthdays'); alert(await r.text()); }catch(e){ alert('Failed: '+e); } }
async function sendAnniversaries(){ try{ const r = await fetch('/send-anniversaries'); alert(await r.text()); }catch(e){ alert('Failed: '+e); } }






</script>
</body>
</html>
